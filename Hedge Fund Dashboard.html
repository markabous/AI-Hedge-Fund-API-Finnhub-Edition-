<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hedge Fund Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom Styles for the Markdown Table -->
    <style>
        .prose table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .prose th { background-color: #1f2937; color: #10b981; padding: 0.75rem; text-align: left; border: 1px solid #374151; }
        .prose td { padding: 0.75rem; border: 1px solid #374151; color: #d1d5db; }
        .prose tr:nth-child(even) { background-color: #111827; }
        .prose h1, .prose h2, .prose h3 { color: #f3f4f6; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: 700; }
        .prose h2 { font-size: 1.5rem; border-bottom: 1px solid #374151; padding-bottom: 0.5rem; }
        .prose p { margin-bottom: 1rem; line-height: 1.7; color: #d1d5db; }
        .prose strong { color: #10b981; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">

    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        function App() {
            // STATE
            const [ticker, setTicker] = useState('');
            const [loading, setLoading] = useState(false);
            const [report, setReport] = useState(null);
            const [error, setError] = useState('');

            // CONFIG: PASTE YOUR N8N WEBHOOK URL HERE
            const WEBHOOK_URL = "https://markomater.app.n8n.cloud/webhook-test/analyze-stock"; 

            const analyzeStock = async () => {
                if (!ticker) return;
                setLoading(true);
                setReport(null);
                setError('');

                try {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticker: ticker.toUpperCase() })
                    });

                    if (!response.ok) {
                        throw new Error(`Error: ${response.statusText}. Make sure n8n is running and CORS is enabled.`);
                    }

                    const data = await response.json();
                    
                    // Handle different response structures (Raw string vs JSON object)
                    let markdownContent = "";
                    if (typeof data === 'string') {
                        markdownContent = data;
                    } else if (data.analysis) {
                        markdownContent = data.analysis;
                    } else if (data.content) {
                        markdownContent = data.content;
                    } else if (data.message) {
                         markdownContent = data.message;
                    } else {
                        markdownContent = JSON.stringify(data, null, 2);
                    }

                    setReport(markdownContent);
                } catch (err) {
                    console.error(err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Render Markdown Safely
            const MarkdownDisplay = ({ content }) => {
                const rawMarkup = marked.parse(content);
                const sanitizedMarkup = DOMPurify.sanitize(rawMarkup);
                return <div className="prose" dangerouslySetInnerHTML={{ __html: sanitizedMarkup }} />;
            };

            return (
                <div className="max-w-4xl mx-auto p-6">
                    {/* Header */}
                    <div className="text-center mb-10 mt-10">
                        <h1 className="text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-blue-500 mb-4">
                            AI Hedge Fund
                        </h1>
                        <p className="text-gray-400 text-lg">
                            Institutional Grade Equity Analysis
                        </p>
                    </div>

                    {/* Search Box */}
                    <div className="bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700 mb-8">
                        <label className="block text-sm font-medium text-gray-400 mb-2">ENTER STOCK TICKER</label>
                        <div className="flex gap-4">
                            <input 
                                type="text" 
                                value={ticker}
                                onChange={(e) => setTicker(e.target.value)}
                                placeholder="e.g. AAPL, TSLA, NVDA"
                                className="flex-1 bg-gray-900 text-white px-6 py-4 rounded-lg border border-gray-600 focus:border-green-500 focus:outline-none text-xl uppercase tracking-wider"
                                onKeyDown={(e) => e.key === 'Enter' && analyzeStock()}
                            />
                            <button 
                                onClick={analyzeStock}
                                disabled={loading}
                                className={`px-8 py-4 rounded-lg font-bold text-lg transition-all ${loading ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-500 hover:shadow-green-500/20 hover:shadow-lg'}`}
                            >
                                {loading ? (
                                    <span><i className="fas fa-circle-notch fa-spin mr-2"></i> Analyzing...</span>
                                ) : (
                                    <span><i className="fas fa-chart-line mr-2"></i> Analyze</span>
                                )}
                            </button>
                        </div>
                    </div>

                    {/* Error Message */}
                    {error && (
                        <div className="bg-red-900/50 border border-red-500 text-red-200 p-4 rounded-lg mb-8">
                            <i className="fas fa-exclamation-triangle mr-2"></i> {error}
                        </div>
                    )}

                    {/* Report Display */}
                    {report && (
                        <div className="bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700 animate-fade-in">
                            <div className="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                                <h2 className="text-2xl font-bold text-white">
                                    <i className="fas fa-file-invoice-dollar text-green-400 mr-2"></i> 
                                    Analysis: {ticker.toUpperCase()}
                                </h2>
                                <span className="bg-blue-900 text-blue-200 text-xs px-3 py-1 rounded-full">
                                    Llama 3.3 70B
                                </span>
                            </div>
                            
                            {/* The Magic: Renders Markdown as Real HTML */}
                            <MarkdownDisplay content={report} />
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>